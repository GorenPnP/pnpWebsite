version: '3.7'

services:
        web:
                container_name: pnp-web
                build:
                        context: ./ppServer
                        dockerfile: Dockerfile.prod
                command: gunicorn ppServer.wsgi:application --bind 0.0.0.0:8000 --workers=3
                volumes:
                        - static_volume:/home/ppServer/web/static
                        - media_volume:/home/ppServer/web/media
                        - ./backups:/home/ppServer/backups      # is mounted on dir ./backups
                expose:
                        - 8000
                env_file:
                        - ./.env.prod
                depends_on:
                        - db

        db:
                container_name: pnp-db
                image: postgres:12.0-alpine
                volumes:
                        - postgres_data:/var/lib/postgresql/data/
                env_file:
                        - ./.env.prod.db

        nginx:
                container_name: pnp-nginx
                build: ./nginx
                volumes:
                        - static_volume:/home/ppServer/web/static
                        - media_volume:/home/ppServer/web/media
                ports:
                        - 80:80
                depends_on:
                        - web
        
        # cron-backup:
        #         container_name: pnp-cron-backup
        #         build: ./cronjobs/backup
        #         volumes:
        #                 - ./ppServer/media:/usr/src/media
        #                 - postgres_data:/var/lib/postgresql/data
        #                 - ./backups:/usr/src/backups
        #         env_file:
        #                 - ./.env.prod.db

volumes:
        postgres_data:
        static_volume:
        media_volume:
